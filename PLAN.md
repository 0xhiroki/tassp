# PLAN: Smart Session Planner (Authoritative Build Plan)

> **Purpose**: Single source of truth for how the existing Smart Session Planner is structured, how to work on it, and what to focus on next. Use this document instead of the outdated ‚Äú6-hour plan‚Äù playbook.

**Last Updated:** 2025-11-24  
**Maintainers:** @hiroki (owner), Droid assistants  
**Audience:** Engineers shipping features, reviewers evaluating the take-home submission.

---

## Table of Contents
1. [Quick TL;DR](#1-quick-tldr)
2. [Project Overview](#2-project-overview)
3. [Tech Stack & Tooling](#3-tech-stack--tooling)
4. [Data Model](#4-data-model)
5. [Architecture & Module Map](#5-architecture--module-map)
6. [Feature Implementation Notes](#6-feature-implementation-notes)
7. [Build & Validation Workflow](#7-build--validation-workflow)
8. [Known Constraints & Near-Term Enhancements](#8-known-constraints--near-term-enhancements)
9. [Quick Reference](#9-quick-reference)

---

## 1. Quick TL;DR
- **Goal:** Help a single demo user plan sessions by combining manual scheduling, availability windows, and smart suggestions surfaced in an Expo app backed by a Next.js API + Prisma/Postgres.
- **State:** Frontend + backend are fully wired. Session type categories, stats, and the suggestion engine are live. Env templates, lint/test suites, and Prisma migrations exist (migrations stay local and gitignored).
- **Takeaways:** Keep secrets + migrations out of git, run lint/tests before commits, and use this PLAN as the authoritative reference.

---

## 2. Project Overview

| Flow | What the user does | Key files |
| --- | --- | --- |
| **Setup** | Define session types (name, category tag, icon, color) and weekly availability windows. | `frontend/app/(tabs)/settings.tsx`, `frontend/components/SessionTypeSheet.tsx`, `frontend/components/AvailabilitySheet.tsx`, `backend/app/api/session-types/*`, `backend/app/api/availability/route.ts` |
| **Manual Scheduling** | Create or adjust sessions with conflict detection and optional description. | `frontend/components/SessionModal.tsx`, `frontend/contexts/data-context.tsx`, `backend/app/api/sessions/*`, `backend/lib/overlap.ts` |
| **Smart Suggestions** | Request or accept slots generated by the heuristic + optional OpenAI blurb. | `frontend/app/(tabs)/index.tsx`, `frontend/components/SuggestionCard.tsx`, `backend/app/api/suggestions/*`, `backend/lib/suggestion-engine.ts`, `backend/lib/ai.ts` |
| **Tracking/Insights** | Review progress, completion rates, and type/category breakdowns. | `frontend/app/(tabs)/stats.tsx`, `frontend/components/ProgressOverview.tsx`, `backend/app/api/metrics/route.ts` |

**Value Proposition:** Automate choosing the best time for focus blocks or commitments by blending deterministic constraints (availability, conflicts) with heuristic ranking and AI-generated descriptions.

---

## 3. Tech Stack & Tooling

### 3.1 Frontend (Expo / React Native)
| Stack | Version | Notes |
| --- | --- | --- |
| Expo Router | ~6.0.15 (Expo SDK 54 / `expo@54.0.25`) | Tabs layout under `frontend/app/(tabs)`.
| React / React Native | 19.1.0 / 0.81.5 | RN 0.81 uses the new Fabric architecture by default.
| TypeScript | ~5.9.2 | Configured via `frontend/tsconfig.json`.
| UI foundation | Custom primitives in `frontend/components/` (Card, BottomSheet, ProgressBar). Color palette + session icon metadata in `frontend/constants/`.
| Data orchestration | `frontend/contexts/data-context.tsx` shares state + mutation helpers using typed service modules in `frontend/services/*`.

### 3.2 Backend (Next.js App Router)
| Stack | Version | Notes |
| --- | --- | --- |
| Next.js | 16.0.3 | API routes under `backend/app/api/*/route.ts`.
| Prisma | 5.22.0 | Schema in `backend/prisma/schema.prisma`; migrations live locally and remain gitignored.
| Vitest | 4.0.13 | Used for API + helper coverage (see `backend/app/api/**/*.test.ts`, `backend/lib/suggestion-engine.test.ts`).
| Optional AI | `openai@6.9.1` provides short-form suggestion blurbs when `OPENAI_API_KEY` is set.

### 3.3 Shared Tooling
- **Node:** 20.19.0 (`.nvmrc`).
- **Makefile:** `make setup`, `make backend`, `make frontend`, `make clean-postgres`.
- **Linters/tests:** `npm run lint` + `npm run test` per package; both must pass before handing in work.
- **Env templates:** `frontend/.env.example`, `backend/.env.local.example`.

---

## 4. Data Model

### 4.1 Entities & Relationships
```
User (demo only)
 ‚îú‚îÄ SessionType (name, category, priority, color, icon, completedCount)
 ‚îú‚îÄ Session (sessionTypeId, startTime, durationMinutes, description, completedAt?)
 ‚îú‚îÄ AvailabilityWindow (dayOfWeek, startTime, endTime)
 ‚îî‚îÄ Suggestion (sessionTypeId, startTime, durationMinutes, reason, AI description)
```

### 4.2 Prisma Snapshot
```prisma
model SessionType {
  id             String   @id @default(cuid())
  userId         String
  name           String
  category       String
  priority       Int
  color          String
  icon           String   @default("üéØ")
  completedCount Int      @default(0)
  createdAt      DateTime @default(now())
  sessions       Session[]
  suggestions    Suggestion[]
}

model Session {
  id              String    @id @default(cuid())
  userId          String
  sessionTypeId   String
  description     String    @default("")
  startTime       DateTime
  durationMinutes Int
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  sessionType     SessionType @relation(fields: [sessionTypeId], references: [id], onDelete: Cascade)
}

model AvailabilityWindow {
  id        String   @id @default(cuid())
  userId    String
  dayOfWeek Int
  startTime String
  endTime   String
}

model Suggestion {
  id              String   @id @default(cuid())
  userId          String
  sessionTypeId   String
  startTime       DateTime
  durationMinutes Int
  reason          String
  description     String   @default("")
}
```

**Implementation Notes**
- `DEMO_USER_ID` is enforced in each route (see `backend/lib/demo-user.ts`).
- Session types store a required `category` tag used in stats + settings.
- Suggestions persist server-side so refetching the Expo client always yields deterministic results.

---

## 5. Architecture & Module Map

### 5.1 Repository Layout
```
take-home-assignment/
‚îú‚îÄ‚îÄ frontend/                 # Expo app
‚îÇ   ‚îú‚îÄ‚îÄ app/(tabs)/           # index, calendar, stats, settings
‚îÇ   ‚îú‚îÄ‚îÄ components/           # PageHeader, BottomSheet, SessionModal, etc.
‚îÇ   ‚îú‚îÄ‚îÄ contexts/             # data-context.tsx
‚îÇ   ‚îú‚îÄ‚îÄ services/             # REST client wrappers (sessionTypes, sessions, availability, suggestions, metrics)
‚îÇ   ‚îî‚îÄ‚îÄ constants/            # Colors + session icon metadata
‚îú‚îÄ‚îÄ backend/                  # Next.js API
‚îÇ   ‚îú‚îÄ‚îÄ app/api/*/route.ts    # REST endpoints (sessions, session-types, availability, suggestions, metrics, health)
‚îÇ   ‚îú‚îÄ‚îÄ lib/                  # Suggestion engine, validation, OpenAI helper, Prisma client, overlap utilities
‚îÇ   ‚îú‚îÄ‚îÄ scripts/              # reset-demo-data.ts, refresh-suggestions.ts
‚îÇ   ‚îî‚îÄ‚îÄ prisma/schema.prisma
‚îú‚îÄ‚îÄ docs/                     # PRD + completed task docs per DOC_TEMPLATE
‚îú‚îÄ‚îÄ Makefile                  # Setup + dev helpers
‚îî‚îÄ‚îÄ PLAN.md                   # (this file)
```

### 5.2 Cross-Cutting Modules
- **Data context (`frontend/contexts/data-context.tsx`):** central source of truth for everything the Expo app needs. Handles initial fetch, optimistic updates, and invalidation for session types, sessions, suggestions, and metrics.
- **Suggestion engine (`backend/lib/suggestion-engine.ts`):** deterministic heuristic that respects availability, spacing, and per-day limits. Called by `backend/app/api/suggestions/route.ts` and optionally decorated by `backend/lib/ai.ts` when OpenAI is configured.
- **Metrics endpoint (`backend/app/api/metrics/route.ts`):** aggregates completion stats that drive `frontend/app/(tabs)/stats.tsx` and the home tab infographic.

---

## 6. Feature Implementation Notes

### 6.1 Session Types & Categories
- **UI:** `frontend/app/(tabs)/settings.tsx` renders the list; `frontend/components/SessionTypeSheet.tsx` handles create/edit (category input is required). Color choices are sourced from `frontend/constants/sessionIcons.ts` and kept in sync with `backend/lib/session-icons.ts`.
- **API:** CRUD routes in `backend/app/api/session-types` validate payloads via `backend/lib/validation.ts`. Completed counts increment when sessions move to `COMPLETED`.
- **Seed data:** `backend/scripts/reset-demo-data.ts` creates a balanced set with pre-filled categories.

### 6.2 Availability Windows
- Sheets UI lets users add windows per weekday. Saving calls `PUT /api/availability` which deletes + recreates rows in a single request to keep the weekly grid canonical.
- Validation ensures `startTime < endTime` and normalizes to 15-minute increments.
- Deleting a window (or removing it during an update) automatically removes any sessions scheduled in that weekly slot to avoid dangling data.

### 6.3 Sessions & Manual Scheduling
- `frontend/components/SessionModal.tsx` uses the context to create/update/delete and warns on overlaps before submitting.
- Backend uses `backend/lib/overlap.ts` to enforce a 15-minute buffer between sessions for the same user.
- Descriptions are optional strings. When provided, they sync through `PATCH /api/sessions/:id`.

### 6.4 Smart Suggestions
- `GET /api/suggestions` regenerates entries when the table is empty or stale (>12 hours). `POST /api/suggestions` forces a refresh.
- Engine inputs:
  - Availability windows over the next 21 days (`MAX_DAY_LOOKAHEAD`).
  - Priority-weighted duration presets and category-level spacing heuristics.
  - Per-day caps (`MAX_HIGH_PRIORITY_PER_DAY`).
- Accepting a suggestion (`POST /api/suggestions/[id]/accept`) checks conflicts again, creates a session, removes the suggestion, and returns both the session and the refreshed suggestion list.
- `backend/lib/ai.ts` adds short motivational blurbs via OpenAI when configured; otherwise we fall back to deterministic copy (`buildFallbackDescription`).

### 6.5 Progress & Metrics
- `frontend/app/(tabs)/stats.tsx` shows KPI cards (scheduled, completed, completion %, avg spacing) plus a per-type card that surfaces each type's `category` label.
- Metrics data comes from `metricsService.get()` which wraps `GET /api/metrics`.
- The home tab uses `frontend/components/ProgressOverview.tsx` for a scoped summary (today/week).

---

## 7. Build & Validation Workflow

### 7.1 Environment Setup
```bash
nvm use
make setup              # Copies env templates, installs deps, starts Postgres, runs prisma generate/migrate, seeds demo data
```

Manual alternative:
```bash
cp frontend/.env.example frontend/.env
cp backend/.env.local.example backend/.env.local
cd frontend && npm install
cd backend && npm install
docker run --name take-home-postgres -e POSTGRES_USER=smart -e POSTGRES_PASSWORD=smart \
  -e POSTGRES_DB=smart_session -p 5433:5432 -d postgres:16
cd backend && npx prisma migrate deploy && npm run seed
```

### 7.2 Daily Dev Loop
| Task | Command |
| --- | --- |
| Start backend API | `cd backend && npm run dev` |
| Start Expo dev client | `cd frontend && npm run start` |
| Refresh suggestions | `cd backend && npm run refresh:suggestions` |
| Reseed demo data | `cd backend && npm run seed` |

### 7.3 Required Validators
- **Backend:** `cd backend && npm run lint && npm run test`
- **Frontend:** `cd frontend && npm run lint && npm run test`

Run both suites before sending work for review.

### 7.4 Git Hygiene
- `backend/prisma/migrations/` remains gitignored; regenerate locally as needed.
- `.env*` files are ignored everywhere. Copy from templates instead of committing secrets.
- Commits follow Conventional Commit format (e.g., `feat(frontend): add stats view`, ‚â§72 char subject).

---

## 8. Known Constraints & Near-Term Enhancements
1. **Single-user assumption:** Schema is multi-tenant-ready but everything still hardcodes `DEMO_USER_ID`. Add auth + user scoping before multi-user release.
2. **DataContext size:** Still manageable but trending large. Split into resource-specific hooks if logic grows.
3. **Offline/caching:** The Expo client relies on live HTTP calls. Introduce React Query or persistent storage if offline work is required.
4. **Suggestion explainability:** Current heuristics expose the `reason` string but not the detailed scoring inputs. Consider surfacing more context for power users.

---

## 9. Quick Reference

### 9.1 Commands
```bash
# Frontend
cd frontend
npm run start        # Expo dev client
npm run lint         # ESLint (ts/tsx)
npm run test         # Vitest

# Backend
cd backend
npm run dev          # Next.js API on http://localhost:3000
npm run lint
npm run test
npm run seed
npm run refresh:suggestions

# Root helpers
make setup
make backend
make frontend
make clean-postgres
```

### 9.2 Environment Variables
| File | Key | Purpose |
| --- | --- | --- |
| `frontend/.env` | `EXPO_PUBLIC_API_URL` | Points the Expo app at the local/remote API (default `http://localhost:3000/api`). |
| `backend/.env.local` | `DATABASE_URL` | Postgres DSN. |
|  | `OPENAI_API_KEY` | Optional. Enables AI-generated suggestion blurbs. |

### 9.3 File Lookup
| Area | File |
| --- | --- |
| Home tab logic | `frontend/app/(tabs)/index.tsx` |
| Stats tab | `frontend/app/(tabs)/stats.tsx` |
| Settings tab | `frontend/app/(tabs)/settings.tsx` + `frontend/components/SessionTypeSheet.tsx` + `frontend/components/AvailabilitySheet.tsx` |
| Session modal | `frontend/components/SessionModal.tsx` |
| Suggestion card | `frontend/components/SuggestionCard.tsx` |
| Shared data context | `frontend/contexts/data-context.tsx` |
| REST client | `frontend/services/api-client.ts` + resource modules |
| Suggestion API | `backend/app/api/suggestions/route.ts`, `backend/app/api/suggestions/[id]/accept/route.ts` |
| Heuristic engine | `backend/lib/suggestion-engine.ts` |
| AI helper | `backend/lib/ai.ts` |
| Prisma schema | `backend/prisma/schema.prisma` |

---

**Reminder:** Keep migrations + secrets out of git, run validators before commits, and treat this PLAN as the live playbook for maintainers and reviewers.
